services:
    snippets-mongo:
        image: mongo:latest
        ports:
            - "127.0.0.1:27017:27017"
        environment:
            - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER} 
            - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
        volumes:
            - snippets_mongo_data:/mongo_data
    meilisearch:
        image: getmeili/meilisearch:v1.5
        ports:
            - "127.0.0.1:7700:7700"
        environment:
            - MEILI_NO_ANALYTICS=true
            - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
        volumes:
            - meili_data:/meili_data
    keycloak:
        image: quay.io/keycloak/keycloak:latest
        command: start-dev
        environment:
            KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER}
            KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASS}
            KC_HEALTH_ENABLED: true
        ports:
            - "8080:8080"
        volumes:
            - keycloak_data:/opt/keycloak/data/
        healthcheck:
            test: [ "CMD-SHELL", "curl --head -fsS http://localhost:9000/health/ready | echo $?" ]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 40s
    snippets-service:
        build: ./snippets-ms
        ports:
            - "8000:8000"
        depends_on:
            keycloak:
                condition: service_healthy
            snippets-mongo:
                condition: service_started
        environment:
            - MONGO_HOST=snippets-mongo
            - MONGO_USER=${MONGO_USER}
            - MONGO_PASSWORD=${MONGO_PASSWORD}
            - SEARCH_SERVICE_ADDRESS=search-service:50051
            - KEYCLOAK_URL=http://keycloak:8080/realms/codesnip-realm
            - KEYCLOAK_HASH_ALGORITHM=RS256
    search-service:
        build: ./search-ms
        ports:
            - "127.0.0.1:50051:50051"
        depends_on:
            - meilisearch
        environment:
            - MEILI_HOST=http://meilisearch:7700
            - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
    saves-mongo:
        image: mongo:latest
        ports:
            - "127.0.0.1:27018:27018"
        environment:
            - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
            - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
        volumes:
            - saves_mongo_data:/mongo_data
    saves-service:
        build: ./saves-ms
        ports:
            - "8001:8000"
        depends_on:
            keycloak:
                condition: service_healthy
            saves-mongo:
                condition: service_started
        environment:
            - MONGO_HOST=saves-mongo
            - MONGO_USER=${MONGO_USER}
            - MONGO_PASSWORD=${MONGO_PASSWORD}
            - KEYCLOAK_URL=http://keycloak:8080/realms/codesnip-realm
            - KEYCLOAK_HASH_ALGORITHM=RS256
volumes:
    snippets_mongo_data:
        name: "codesnip-snippets-mongo"
    meili_data:
        name: "codesnip-meili"
    keycloak_data:
        name: "codesnip-keycloak"
    saves_mongo_data:
        name: "codesnip-saves-mongo"